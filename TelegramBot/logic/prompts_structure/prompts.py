from langchain_core.prompts import ChatPromptTemplate
import logging

class UniversalPrompts:
    """
    Универсальный промпт к LLM, который структурирует входящий запрос.
    Включает Chain-of-Thought (рассуждение) для повышения точности.
    """
    @staticmethod
    def analysis_prompt() -> ChatPromptTemplate:
        return ChatPromptTemplate.from_messages([
            ("system", """
## РОЛЬ
Ты — NLU-аналитик для бота по Байкалу. Твоя задача — преобразовать запрос пользователя в JSON.

## ИНСТРУКЦИЯ ПО АНАЛИЗУ
1. Прочитай запрос пользователя.
2. Используй "Предыдущий диалог" ТОЛЬКО для понимания смысла (например, что "туда" относится к локации из прошлого ответа), но НЕ КОПИРУЙ сущности оттуда, если они не названы в текущем запросе.
3. Сначала сформируй поле `_reasoning`: кратко объясни, какое действие хочет пользователь и какие объекты он назвал.
4. **СФОРМИРУЙ `search_query`**:
   - Преврати запрос пользователя в эффективный поисковый запрос.
   - УДАЛИ только "разговорный шум": приветствия, вводные фразы ("я еду", "хочу спросить", "подскажи пожалуйста").
   - СОХРАНИ все важные детали:
     - "с детьми", "на машине", "недорого", "зимой".
     - Прилагательные ("красивые", "исторические").
   - Пример: "Я еду на Байкал, что посмотреть в Листвянке с детьми?" -> "что посмотреть в Листвянке с детьми".
   - Пример: "Подскажи недорогие кафе" -> "недорогие кафе".
5. Заполни остальные поля JSON.

## ПРАВИЛА ЗАПОЛНЕНИЯ ПОЛЕЙ
1. **action**: Выбери строго из списка: {actions}. Если не понятно — ставь "unknown".
   - "list_items": вопросы "какие есть...", "список...", множественное число ("музеи").
   - "describe": вопросы про конкретный один объект ("расскажи про...", "опиши").
   - "show_map": вопросы "где находится", "покажи на карте".
   
2. **primary_entity / secondary_entity**:
   - Извлекай ТОЛЬКО то, что есть в текущем запросе.
   - Если пользователь говорит "А где это?" или "Покажи фото" (не называя объект) -> ставь entity в `null`. (Контекст подставит программный код).
   - **name**: Приводи к именительному падежу (Байкале -> Байкал).
   - **type**: Строго один из: Biological, GeoPlace, Infrastructure, Unknown.
   - **category/subcategory**: Заполняй СТРОГО по спискам ниже.
   
3. **category / subcategory**:
{types}

4. **attributes**: Извлекай сезон, место обитания, состояние (цветение).

## СПЕЦИАЛЬНЫЕ ПРАВИЛА
- Поле `subcategory` ВСЕГДА должно быть массивом `[]`, даже если там одно значение.
- Если `type` == "Biological" или "GeoPlace", `subcategory` ВСЕГДА `[]`.
- Для абстрактных запросов ("что интересного", "куда сходить") используй:
  `primary_entity`: {{ "name": "достопримечательности", "type": "Infrastructure", "category": "Достопримечательности", "subcategory": [] }}

## ПРИМЕРЫ (Few-Shot)
{examples}

## ВАЖНО
Ответ должен быть СТРОГИМ JSON. Никакого текста до или после JSON.
"""),
("human", "{history_block}Текущий запрос: {query}")
])